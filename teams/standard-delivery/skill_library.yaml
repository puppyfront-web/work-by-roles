# Skill Library Definition
# Schema Version: 1.0

schema_version: "1.0"
skills:
  - id: "requirements_analysis"
    name: "Requirements Analysis"
    description: "Ability to elicit, structure, and validate requirements"
    dimensions:
      - "elicitation"
      - "scope_alignment"
      - "acceptance_criteria"
    levels:
      1: "Understands basic templates and can capture user needs"
      2: "Can model flows, risks, and non-functional needs"
      3: "Leads complex discovery, reconciles conflicting stakeholders"
    tools:
      - "markdown"
      - "diagrams"
    constraints:
      - "must_define_acceptance_criteria"
      - "must_document_risks"

  - id: "schema_design"
    name: "Schema and DSL Design"
    description: "Design structured schemas and DSLs with validation rules"
    dimensions:
      - "structure_modelling"
      - "validation_rules"
      - "extensibility"
    levels:
      1: "Designs simple schemas with required fields"
      2: "Adds validation, versioning, and compatibility rules"
      3: "Designs evolvable DSLs with backward compatibility"
    tools:
      - "yaml"
      - "jsonschema"
    constraints:
      - "must_define_schema_version"
      - "must_define_validation_rules"

  - id: "system_design"
    name: "System Architecture"
    description: "Architect systems with clear separation of concerns"
    dimensions:
      - "componentization"
      - "data_flow"
      - "quality_attributes"
    levels:
      1: "Defines core components and interactions"
      2: "Covers resiliency, extensibility, and validation flows"
      3: "Optimizes for scale, evolution, and governance"
    tools:
      - "mermaid"
      - "architecture_decision_records"
    constraints:
      - "must_define_quality_gates"

  - id: "python_engineering"
    name: "Python Engineering"
    description: "Build production-grade Python in {{project.paths.src}} with typing and testing"
    dimensions:
      - "typing"
      - "testing"
      - "error_handling"
    levels:
      1: "Writes typed functions and basic tests"
      2: "Designs modules with dataclasses and robust errors"
      3: "Delivers frameworks with strong contracts and tooling"
    tools:
      - "{{project.standards.ruff or 'ruff'}}"
      - "{{project.standards.mypy or 'mypy'}}"
      - "{{project.standards.pytest or 'pytest'}}"
    constraints:
      - "must_use_type_hints"
      - "must_cover_tests in {{project.paths.tests}}"

  - id: "test_driven_development"
    name: "Test Driven Development"
    description: "Designs tests in {{project.paths.tests}} before implementation"
    dimensions:
      - "unit_tests"
      - "integration_tests"
      - "coverage_goals"
    levels:
      1: "Writes unit tests for core logic"
      2: "Covers edge cases and negative paths"
      3: "Designs executable specifications and fixtures"
    tools:
      - "{{project.standards.pytest or 'pytest'}}"
      - "coverage"
    constraints:
      - "must_block_on_test_failure"

  - id: "quality_assurance"
    name: "Quality Assurance & Validation"
    description: "Validates outputs, gates, and workflow compliance"
    dimensions:
      - "gate_definition"
      - "reporting"
      - "automation"
    levels:
      1: "Runs manual checks and reports results"
      2: "Automates gate execution and reporting"
      3: "Designs reusable validation suites and metrics"
    tools:
      - "pytest"
      - "report_generators"
    constraints:
      - "must_record_findings"

skill_bundles:
  - id: "web_delivery_bundle"
    name: "Web Delivery"
    description: "Standard bundle for web application delivery"
    skills:
      - skill_id: "requirements_analysis"
        min_level: 2
      - skill_id: "schema_design"
        min_level: 2
      - skill_id: "python_engineering"
        min_level: 2

  - id: "core_framework_bundle"
    name: "Core Framework"
    description: "Essential skills for framework engineering"
    skills:
      - skill_id: "python_engineering"
        min_level: 2
      - skill_id: "test_driven_development"
        min_level: 2

# Skill Workflows - 多技能组合形成的工作流
# 定义技能之间的执行顺序、数据流和依赖关系
skill_workflows:
  - id: "feature_delivery"
    name: "功能交付流程"
    description: "从需求到实现的完整功能交付工作流"
    # 触发条件（可选）
    trigger:
      stage_id: "implementation"  # 在哪个阶段自动触发
      condition: "auto"           # auto | manual | on_event
    
    # 技能步骤定义
    steps:
      - step_id: "analyze_requirements"
        skill_id: "requirements_analysis"
        name: "分析需求"
        order: 1
        # 输入映射：从工作流输入或前序步骤获取数据
        inputs:
          goal: "{{workflow.inputs.goal}}"
          context: "{{workflow.inputs.context}}"
        # 输出声明：该步骤产生的输出
        outputs:
          - "requirements_doc"
          - "acceptance_criteria"
        # 执行配置
        config:
          timeout: 300
          retry_on_failure: true
      
      - step_id: "design_schema"
        skill_id: "schema_design"
        name: "设计数据结构"
        order: 2
        # 前置依赖
        depends_on:
          - "analyze_requirements"
        # 输入从前序步骤获取
        inputs:
          requirements: "{{steps.analyze_requirements.outputs.requirements_doc}}"
          criteria: "{{steps.analyze_requirements.outputs.acceptance_criteria}}"
        outputs:
          - "data_schema"
          - "api_contract"
        config:
          timeout: 300
      
      - step_id: "implement_code"
        skill_id: "python_engineering"
        name: "实现代码"
        order: 3
        depends_on:
          - "design_schema"
        inputs:
          schema: "{{steps.design_schema.outputs.data_schema}}"
          api_contract: "{{steps.design_schema.outputs.api_contract}}"
        outputs:
          - "source_code"
          - "module_path"
        config:
          timeout: 600
      
      - step_id: "write_tests"
        skill_id: "test_driven_development"
        name: "编写测试"
        order: 3  # 与 implement_code 相同 order，支持并行
        depends_on:
          - "design_schema"
        inputs:
          schema: "{{steps.design_schema.outputs.data_schema}}"
          acceptance_criteria: "{{steps.analyze_requirements.outputs.acceptance_criteria}}"
        outputs:
          - "test_code"
          - "test_path"
        config:
          timeout: 600
          parallel_with: ["implement_code"]  # 显式声明可并行
      
      - step_id: "validate_quality"
        skill_id: "quality_assurance"
        name: "质量验证"
        order: 4
        depends_on:
          - "implement_code"
          - "write_tests"
        inputs:
          source_code: "{{steps.implement_code.outputs.source_code}}"
          test_code: "{{steps.write_tests.outputs.test_code}}"
        outputs:
          - "validation_report"
          - "quality_score"
        config:
          timeout: 300
          required: true  # 必须成功才能完成工作流
    
    # 工作流输出映射
    outputs:
      final_code: "{{steps.implement_code.outputs.source_code}}"
      final_tests: "{{steps.write_tests.outputs.test_code}}"
      quality_report: "{{steps.validate_quality.outputs.validation_report}}"
    
    # 工作流级别配置
    config:
      max_parallel: 2          # 最大并行步骤数
      fail_fast: false         # 是否在第一个失败时停止
      retry_failed_steps: true # 是否重试失败的步骤

  - id: "code_review_workflow"
    name: "代码审查流程"
    description: "代码质量审查和改进工作流"
    trigger:
      condition: "manual"
    steps:
      - step_id: "analyze_code"
        skill_id: "python_engineering"
        name: "分析代码结构"
        order: 1
        inputs:
          code_path: "{{workflow.inputs.code_path}}"
        outputs:
          - "code_analysis"
          - "improvement_suggestions"
      
      - step_id: "review_quality"
        skill_id: "quality_assurance"
        name: "审查代码质量"
        order: 2
        depends_on:
          - "analyze_code"
        inputs:
          code_analysis: "{{steps.analyze_code.outputs.code_analysis}}"
        outputs:
          - "quality_report"
          - "issues_found"
    
    outputs:
      analysis: "{{steps.analyze_code.outputs.code_analysis}}"
      quality: "{{steps.review_quality.outputs.quality_report}}"

